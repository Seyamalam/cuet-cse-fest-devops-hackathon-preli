# =============================================================================
# Docker Compose - Production Environment
# =============================================================================
# Features:
# - Optimized production builds
# - Only gateway port exposed (5921)
# - Backend and MongoDB isolated on internal network
# - Named volumes for data persistence
# - Resource limits to prevent DoS
# - Security hardening (no-new-privileges, read-only where applicable)
# - Health checks for proper startup ordering
# - Restart policies for reliability
# =============================================================================

services:
  # ===========================================================================
  # Gateway Service - API Entry Point (ONLY EXPOSED SERVICE)
  # ===========================================================================
  gateway:
    build:
      context: ../gateway
      dockerfile: Dockerfile
    container_name: gateway-prod
    ports:
      # Only gateway is exposed externally
      - "${GATEWAY_PORT:-5921}:5921"
    environment:
      - NODE_ENV=production
      - GATEWAY_PORT=5921
      - BACKEND_URL=http://backend:3847
    networks:
      - frontend-network
      - backend-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5921/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    # Security: prevent privilege escalation
    security_opt:
      - no-new-privileges:true
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # Backend Service - Business Logic (INTERNAL ONLY)
  # ===========================================================================
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: backend-prod
    # Backend is NOT exposed externally - internal only
    expose:
      - "3847"
    environment:
      - NODE_ENV=production
      - BACKEND_PORT=3847
      - MONGO_URI=mongodb://${MONGO_APP_USERNAME:-app_user}:${MONGO_APP_PASSWORD:-app_password}@mongo:27017/${MONGO_DATABASE:-ecommerce}?authSource=${MONGO_DATABASE:-ecommerce}
      - MONGO_DATABASE=${MONGO_DATABASE:-ecommerce}
    networks:
      # Backend only on backend network - not accessible from frontend
      - backend-network
    depends_on:
      mongo:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3847/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    # Security: prevent privilege escalation
    security_opt:
      - no-new-privileges:true
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # MongoDB Service - Database (INTERNAL ONLY)
  # ===========================================================================
  mongo:
    image: mongo:7
    container_name: mongo-prod
    # MongoDB is NOT exposed externally - internal only
    expose:
      - "27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD:-admin_password}
      - MONGO_DATABASE=${MONGO_DATABASE:-ecommerce}
      - MONGO_APP_USERNAME=${MONGO_APP_USERNAME:-app_user}
      - MONGO_APP_PASSWORD=${MONGO_APP_PASSWORD:-app_password}
    volumes:
      # Data persistence with named volume
      - mongo-data-prod:/data/db
      # MongoDB initialization script
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      # MongoDB only on backend network - completely isolated
      - backend-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    # Security: prevent privilege escalation
    security_opt:
      - no-new-privileges:true
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

# =============================================================================
# Networks
# =============================================================================
# Two-tier network architecture for defense in depth:
# - frontend-network: Gateway only (connects to external world)
# - backend-network: Backend + MongoDB (completely isolated)
# =============================================================================
networks:
  frontend-network:
    driver: bridge
    name: ecommerce-frontend-prod
  backend-network:
    driver: bridge
    name: ecommerce-backend-prod
    internal: true  # No external access - completely isolated

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mongo-data-prod:
    name: ecommerce-mongo-data-prod
